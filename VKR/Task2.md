# Задание 2: Требования и уточнение задачи

## Техническое задание на систему «Контроль дорожного полотна»

### 1. Функциональные требования

#### 1.1. Детекция дефектов дорожного полотна

Система должна автоматически обнаруживать и классифицировать следующие типы дефектов:

- **Ямы и выбоины**: глубина ≥2 см, площадь ≥0.02 м²
- **Продольные/поперечные трещины**: длина ≥10 см
- **Колейность**: глубина ≥1.5 см на полосе шириной 30 см
- **Неровности и волны**: детекция через анализ IMU-вибраций
- **Загрязнения**: масло, лёд, гравий (как потенциальные риски)

#### 1.2. Анализ и классификация дефектов

- Присвоение категории риска: **низкий** / **средний** / **высокий** / **критический**
- Оценка размеров дефекта в метрах (через калибровку по известной ширине полосы)
- Фильтрация ложных срабатываний (тени, мусор, дорожная разметка)
- Корреляция визуальных и инерционных аномалий для снижения ложных срабатываний

#### 1.3. Геолокация и формирование событий

- Привязка дефектов к координатам WGS84 с точностью ≤3 м (усиленная через фильтр Калмана)
- Формирование события, включающего:
  - Тип дефекта
  - Географические координаты (широта, долгота)
  - Временная метка
  - Категория тяжести
  - Фото/видео-фрагмент (5 секунд)
  - Размеры дефекта (длина, ширина, глубина, площадь)

#### 1.4. Интеграция и передача данных

- Отправка критических дефектов в реальном времени (<10 сек)
- Ежедневная выгрузка полного лога в 04:00
- Автономная работа без постоянного интернет-соединения (локальное хранение с последующей передачей)
- Поддержка стандартов: GeoJSON, Protocol Buffers, MQTT, REST API

#### 1.5. Мультисенсорная интеграция

- Синхронизация данных с передней/нижней IP-камеры (1080p@30fps)
- Синхронизация с 6-осевым IMU (500 Гц)
- Интеграция с датчиками подвески
- Синхронизация с GPS/ГЛОНАСС модулем (10 Гц, точность 3 м)

### 2. Нефункциональные требования

#### 2.1. Точность

- **Recall** (обнаружение реальных дефектов): ≥90%
- **Precision** (доля реальных среди найденных): ≥85%
- **mAP@0.5** для детекции: ≥0.85
- **IoU** для сегментации: ≥0.7
- Пространственное разрешение: ≤0.5 м при скорости до 80 км/ч
- Ошибка геопривязки: ≤3 м

#### 2.2. Производительность

- Обработка видеопотока: 1080p@30fps + IMU 500 Гц на одном RK3588
- Задержка от детекции до логирования: ≤300 мс
- Потребление NPU: ≤4 TOPS (оставляя ресурсы для других модулей)
- Пиковое энергопотребление: ≤15 Вт
- Режимы энергосбережения при низкой скорости (<10 км/ч)

#### 2.3. Надёжность

- Работа при температуре: –40°C…+70°C
- Устойчивость к вибрации: до 5g
- Защита данных при аварийном отключении (UPS-конденсатор + journaling ФС)
- MTBF (средняя наработка на отказ): ≥50 000 часов
- Uptime: ≥99% в течение 2 недель тестирования

#### 2.4. Устойчивость к условиям эксплуатации

- Работа при различных погодных условиях (дождь, снег, туман)
- Работа при различных условиях освещения (день, ночь, тени)
- Устойчивость к вибрации транспортного средства
- Фильтрация артефактов (тени, мокрые пятна, следы от шин)

### 3. Интерфейсы

#### 3.1. API

**REST API для передачи событий:**

- `POST /api/v1/events` → JSON с данными о дефекте
  - Формат запроса: JSON (GeoJSON или Protocol Buffers)
  - Формат ответа: JSON с подтверждением приёма

**MQTT для критических событий:**

- Топик: `road-monitoring/critical/{vehicle_id}`
- Формат: Protocol Buffers или JSON
- QoS: 1 (at least once delivery)

**REST API для управления:**

- `GET /api/v1/status` → статус системы
- `GET /api/v1/health` → проверка работоспособности
- `POST /api/v1/config` → обновление конфигурации

#### 3.2. Форматы данных

**Входные форматы:**
- Видео: H.264/H.265 поток с IP-камеры (1080p@30fps)
- IMU: бинарный поток (500 Гц, 6 осей)
- GPS/ГЛОНАСС: NMEA-0183 или протокол GPSD (10 Гц)

**Выходные форматы:**
- События: GeoJSON или Protocol Buffers
- Видео-фрагменты: MP4 (H.264, 5 секунд)
- Фотографии: JPEG (1920x1080)
- Логи: JSON Lines (JSONL)

**Пример структуры события (GeoJSON):**

```json
{
  "type": "Feature",
  "geometry": {
    "type": "Point",
    "coordinates": [37.6173, 55.7558]
  },
  "properties": {
    "event_id": "uuid",
    "timestamp": "2025-01-15T10:30:00Z",
    "defect_type": "pothole",
    "severity": "critical",
    "dimensions": {
      "length": 0.25,
      "width": 0.15,
      "depth": 0.08,
      "area": 0.0375
    },
    "confidence": 0.92,
    "video_fragment_url": "http://...",
    "photo_url": "http://...",
    "imu_correlation": true,
    "vehicle_id": "bus_123",
    "speed_kmh": 45.2
  }
}
```

### 4. Данные

#### 4.1. Источники данных

**Собственные данные:**
- Видеосъёмка дорог в разных регионах, погодных условиях, освещении
- Разметка: bounding boxes + маски сегментации + тяжесть дефекта
- Синхронизация с IMU-логами и данными подвески
- Геопривязка через GPS/ГЛОНАСС

**Открытые датасеты:**
- RDD2022 (Road Damage Detection Dataset) — 26000+ изображений
- CrackForest Dataset — для трещин (118 изображений)
- Cityscapes — для калибровки сцены (5000 изображений)

#### 4.2. Предобработка данных

- Удаление битых файлов
- Фильтрация по размытости (Laplacian variance < 100)
- Конвертация в RGB, нормализация к [0,1]
- Синхронизация временных меток между камерой, IMU и GPS

#### 4.3. Разметка данных

- Инструмент: CVAT или аналогичный
- Политика: bounding boxes + маски сегментации для каждого дефекта
- Аннотация тяжести дефекта (низкий/средний/высокий/критический)
- Калибровка по известным объектам (ширина полосы, решётки ливнёвок) для перевода пикселей в метры

#### 4.4. Разбиение данных

- Train/Val/Test = 70/15/15
- Стратификация по классам дефектов и условиям освещения
- Групповое разбиение: все кадры одного маршрута — в одной выборке

#### 4.5. Аугментация данных

- Color jitter (изменение яркости, контраста, насыщенности)
- Horizontal flip (горизонтальное отражение)
- Motion blur (для имитации движения)
- Не использовать vertical flip (нефизично для дорожного покрытия)
- Аугментация погодных условий (дождь, снег, туман)

#### 4.6. Права и этика данных

- Анонимизация: не хранение персональных данных пассажиров
- Хранение: только данные о дефектах дорожного полотна
- Согласие: информирование через таблички в транспортном средстве (если требуется)
- Соответствие требованиям ГОСТ Р 50597-2017
- Защита данных при аварийном отключении (journaling ФС)

### 5. Приёмочные тесты

#### 5.1. Тесты точности

- Тестирование на валидационном наборе из 200+ изображений с размеченными дефектами
- **Recall ≥ 90%**: система должна обнаружить не менее 90% реальных дефектов
- **Precision ≥ 85%**: не менее 85% обнаруженных дефектов должны быть реальными
- **mAP@0.5 ≥ 0.85**: средняя точность детекции на пороге IoU 0.5
- **IoU ≥ 0.7**: для сегментации дефектов

#### 5.2. Тесты производительности

- Обработка видеопотока 1080p@30fps без пропуска кадров
- Задержка от детекции до логирования ≤300 мс (измеряется на 1000 кадрах)
- Обработка IMU-данных 500 Гц без потери данных
- Энергопотребление ≤15 Вт в пиковом режиме

#### 5.3. Тесты надёжности

- Работа при температуре –40°C…+70°C (тестирование в термокамере)
- Устойчивость к вибрации до 5g (тестирование на вибростенде)
- Тест на отказоустойчивость: симуляция аварийного отключения питания (данные должны сохраниться)
- Uptime ≥99% в течение 2 недель непрерывной работы

#### 5.4. Тесты функциональности

- Детекция всех типов дефектов (ямы, трещины, выбоины, колейность, неровности)
- Корректная классификация тяжести дефектов
- Геопривязка с точностью ≤3 м (сравнение с RTK-GPS)
- Формирование событий с корректными метаданными
- Передача критических событий <10 сек
- Ежедневная выгрузка полного лога в 04:00

#### 5.5. Тесты устойчивости

- Работа при различных погодных условиях (дождь, снег, туман) — тестирование на 50+ сценариях
- Работа при различных условиях освещения (день, ночь, тени) — тестирование на 100+ сценариях
- Фильтрация ложных срабатываний (тени, мусор, дорожная разметка) — false positive rate <15%
- Корреляция визуальных и инерционных аномалий — снижение ложных срабатываний на 30%+

#### 5.6. Интеграционные тесты

- Тестирование на реальном транспортном средстве (автобус/троллейбус)
- Тестирование на 5–10 контрольных маршрутах с известными дефектами
- Проверка синхронизации данных от всех сенсоров
- Проверка передачи данных через MQTT и REST API
- Проверка автономной работы без интернета (24 часа)

### 6. Аппаратные требования

#### 6.1. Платформа

- **Edge-устройство**: Rockchip RK3588
- **Операционная система**: Yocto Linux с патчами реального времени
- **NPU**: 6 TOPS (выделено ≤4 TOPS для системы)

#### 6.2. Сенсоры

- **IP-камера**: 1080p@30fps, направленная на дорожное полотно
- **IMU**: 6-осевой (акселерометр + гироскоп), 500 Гц
- **Датчики подвески**: опционально
- **GPS/ГЛОНАСС**: 10 Гц, точность 3 м (опционально RTK для повышения точности)

#### 6.3. Хранение

- **Локальное хранение**: SQLite (события), MinIO (буфер видео)
- **Защита данных**: UPS-конденсатор + journaling ФС

### 7. Программные требования

#### 7.1. Языки программирования

- **C++**: ядро системы, обработка сенсоров
- **Python**: аналитика, калибровка, обучение моделей

#### 7.2. Библиотеки и инструменты

**Видеоанализ:**
- OpenCV + RGA (аппаратное масштабирование)
- Модели: YOLOv8-seg (сегментация дефектов), U-Net (для трещин)
- Инференс: RKNN Runtime на NPU

**Инерциальный анализ:**
- FFT, вейвлет-преобразование, фильтр Калмана
- Библиотеки: FFTW, Eigen

**Навигация:**
- GPSD + RTK (опционально) + фильтр Калмана для уточнения

**Связь:**
- MQTT 5.0, HTTP/2, WebSocket, Protocol Buffers

**Обновления:**
- RAUC + A/B partitioning для безопасного OTA

### 8. Критерии приёмки

Система считается принятой, если выполнены все требования:

1. Все функциональные требования реализованы и протестированы
2. Метрики точности соответствуют требованиям (Recall ≥90%, Precision ≥85%)
3. Метрики производительности соответствуют требованиям (задержка ≤300 мс)
4. Система прошла все приёмочные тесты
5. Система работает автономно без постоянного интернета
6. Система устойчива к различным условиям эксплуатации
7. Документация и инструкции по эксплуатации подготовлены

