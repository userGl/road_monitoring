## Детекция дефектов дорожного полотна (MVP)

Минимальный прототип сервиса для детекции дефектов дорожного полотна с помощью модели YOLO, доступный через REST API и Jupyter Notebook.

---

### 1. Описание проекта

Проект представляет собой микросервис на FastAPI с одним endpoint'ом `/api/v1/test/detect`, который принимает изображение дороги в формате base64 и возвращает список обнаруженных дефектов с координатами и уверенностью модели.  
Для наглядной демонстрации предусмотрен Jupyter-ноутбук, который отправляет запросы к API, визуализирует результаты детекции и выводит базовые метрики времени обработки.

#### Основная задача MVP

Показать сквозной сценарий: от входного изображения до JSON-ответа сервиса и визуализации детекций.

---

### 2. Структура репозитория

```text
project_root/
├── main.py              # Главный цикл
├── api/
│   └── rest_api.py      # FastAPI приложение с endpoint /api/v1/test/detect
├── jupyter.ipynb        # Демонстрационный Jupyter Notebook
├── models/
│   └── epoch51.pt       # Файл модели YOLO
├── test_images/         # Тестовые изображения дорог
├── requirements.txt     # Зависимости Python
├── README.md            # Документация проекта
└── Changelog.md         # История версий
```

**Ключевые компоненты:**

- `rest_api.py` — FastAPI-приложение, загрузка модели YOLOv8 и обработка запросов.
- `jupyter.ipynb` / `jupyter.py` — отправка изображений на API, визуализация боксов и вывод статистики по детекциям.
- `models` — папка с весами обученной модели для детекции дефектов дорожного полотна.

---

### 3. Скриншоты и демонстрация

 To be done

---

### 4. Установка и зависимости

#### 4.1. Требования

- Поддерживаемая ОС: Linux / Windows
- Python 3.12
- Установленный Git
- Желательно наличие GPU (CUDA) для ускорения детекции, но MVP может работать и на CPU.


#### 4.2. Виртуальное окружение и зависимости

1. Создайте папку проекта.
2. В папке проекта откройте терминал командной строки.
3. Клонируйте репозиторий:
```bash
git clone https://github.com/userGl/road_monitoring
cd <ИМЯ_ПАПКИ_ПРОЕКТА>
```

4. Создайте виртуальное окружение:
```bash
python -m venv .venv
```

5. Активируйте виртуальное окружение:
```bash
# Linux
source .venv/bin/activate

# Windows
.venv\Scripts\activate
```

6. Установите зависимости:
```bash
pip install -r requirements.txt
```


#### 4.3. Веса модели

Необходимо скачать веса модели по ссылке:  
https://cloud.mail.ru/public/1WAH/jp92kHqw2


и поместить файл в папку `models` проекта.

---

### 5. Запуск сервиса

1. В папке проекта откройте терминал командной строки.
2. Активируйте виртуальное окружение:
```bash
# Linux
source .venv/bin/activate

# Windows
.venv\Scripts\activate
```

3. Запустите сервис:
```bash
python main.py
```


---

### 6. Использование API

#### 6.1. Endpoint детекции

```text
POST /api/v1/test/detect
```

Тест детекции дефектов дорожного полотна.

**Тело запроса (JSON):**

```json
{
  "image": "<base64-строка JPEG/PNG изображения>",
  "confidence_threshold": 0.6
}
```

**Параметры:**

- `image` — строка с изображением в base64 без префикса или в формате `data:image/jpeg;base64,...` (префикс будет автоматически отброшен).
- `confidence_threshold` — необязательный порог уверенности детекции (по умолчанию 0.6).

**Пример запроса с curl (Linux/macOS):**

```bash
IMAGE_B64=$(python - << 'EOF'
import base64
from pathlib import Path

with open("test_images/Czech_002942.jpg", "rb") as f:
    print(base64.b64encode(f.read()).decode("utf-8"))
EOF
)

curl -X POST "http://localhost:8080/api/v1/test/detect" \
  -H "Content-Type: application/json" \
  -d "{\"image\": \"${IMAGE_B64}\", \"confidence_threshold\": 0.4}"
```

**Пример ответа:**

```json
{
  "success": true,
  "timestamp": "2025-01-31T12:00:00.000000",
  "image_shape":,[^3]
  "detections": [
    {
      "class_id": 0,
      "class_name": "pothole",
      "confidence": 0.87,
      "bbox": [100.5, 200.3, 300.7, 400.9]
    }
  ],
  "processing_time_ms": 45.21,
  "message": "Обнаружено дефектов: 1"
}
```

**Структура ответа** задаётся моделью `DetectionResponse`:

- `success` — флаг успешной обработки;
- `timestamp` — время обработки запроса;
- `image_shape` — размеры входного изображения `[height, width, channels]`;
- `detections` — список детекций (`class_id`, `class_name`, `confidence`, `bbox`);
- `processing_time_ms` — время обработки в миллисекундах;
- `message` — текстовое сообщение, в т.ч. с количеством найденных дефектов.

---

### 7. Демонстрация в Jupyter Notebook

В репозитории предусмотрен демонстрационный ноутбук `jupyter.ipynb`, который:

- загружает тестовое изображение дороги из `test_images/`;
- отображает исходное изображение;
- конвертирует его в base64 и отправляет POST-запрос на `/api/v1/test/detect`;
- выводит в консоль число найденных дефектов, время обработки и подробности по каждому `bbox`;
- визуализирует все детекции поверх исходного изображения с подписями классов и уверенностью.

**Запуск (пример):**

```bash
# В активированном виртуальном окружении в папке проекта выполните:
jupyter lab
# или
jupyter notebook
```

Затем откройте `jupyter.ipynb`, убедитесь, что:

```python
API_URL = "http://localhost:8080/api/v1/test/detect"
```

и выполните все ячейки.

---

### 8. Тестирование и метрики

Пайплайн обучения и тестирования модели находится в папке `training`
